<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ProShields Estimator v19</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="proshields-logo.png">
  <link rel="apple-touch-icon" href="proshields-logo.png">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f3f4f6;
    }
    .app {
      max-width: 640px;
      margin: 0 auto 32px auto;
      background: #ffffff;
      padding: 16px;
      border-radius: 14px;
      box-shadow: 0 2px 10px rgba(15,23,42,0.08);
      border: 1px solid #e5e7eb;
    }
    .header {
      margin: -16px -16px 12px -16px;
      padding: 16px 12px 12px 12px;
      background: linear-gradient(135deg, #0f766e, #0d9488);
      color: #f9fafb;
      border-radius: 14px 14px 0 0;
      border-bottom: 1px solid rgba(15,23,42,0.15);
      text-align: center;
      position: relative;
    }
    .header-logo {
      width: 60px;
      height: 60px;
      border-radius: 16px;
      background: rgba(15,23,42,0.15);
      margin: 0 auto 6px auto;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .header-logo img {
      max-width: 100%;
      max-height: 100%;
      display: block;
    }
    .header-title {
      font-size: 18px;
      margin: 0;
    }
    .header-sub {
      font-size: 11px;
      margin: 2px 0 0 0;
      opacity: 0.95;
    }
    .client-card {
      background: #f9fafb;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #e5e7eb;
      font-size: 13px;
    }
    .client-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 10px;
    }
    .client-grid .full {
      grid-column: 1 / -1;
    }
    label {
      display: block;
      font-size: 12px;
      margin-bottom: 2px;
    }
    input, select, textarea {
      width: 100%;
      padding: 4px 6px;
      font-size: 12px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      box-sizing: border-box;
      font-family: inherit;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    .top-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 6px 0 4px 0;
      gap: 6px;
      flex-wrap: wrap;
    }
    .project-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 4px 0 2px 0;
    }
    .pbtn {
      flex: 1 1 calc(50% - 6px);
      padding: 6px 8px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid #cbd5f5;
      background: #eef2ff;
      color: #111827;
      cursor: pointer;
      text-align: center;
      box-sizing: border-box;
    }
    .pbtn.active {
      background: #0d9488;
      color: white;
      border-color: #0f766e;
    }
    .btn-main {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #0f766e;
      background: #0d9488;
      color: #fff;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn-ghost {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #cbd5f5;
      background: #ffffff;
      color: #0f172a;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
    }
    .current-project {
      font-size: 11px;
      color: #4b5563;
      margin-top: 2px;
    }
    table {
      border-collapse: collapse;
    }
    .services-table {
      width: 100%;
      margin-top: 8px;
      font-size: 11px;
    }
    .services-table th,
    .services-table td {
      border: 1px solid #e5e7eb;
      padding: 3px;
      text-align: left;
      vertical-align: middle;
    }
    .services-table th {
      background: #f3f4f6;
      font-weight: 600;
    }
    .service-col {
      width: 36%;
    }
    .price-cell {
      width: 90px;
      text-align: right;
      white-space: nowrap;
    }
    .remove-btn {
      border: none;
      background: transparent;
      color: #ef4444;
      font-size: 14px;
      cursor: pointer;
      padding: 0 4px;
    }
    .add-row {
      margin-top: 8px;
      text-align: right;
    }
    .btn {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #0f766e;
      background: #0d9488;
      color: white;
      font-size: 12px;
      cursor: pointer;
    }
    .btn.secondary {
      background: white;
      color: #0f172a;
      border-color: #cbd5f5;
    }
    .btn.small {
      padding: 4px 8px;
      font-size: 11px;
    }
    .card {
      background: #f9fafb;
      border-radius: 10px;
      padding: 10px;
      margin-top: 10px;
      border: 1px solid #e5e7eb;
      font-size: 13px;
    }
    .card h2 {
      font-size: 15px;
      margin: 0 0 8px 0;
    }
    .line {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin: 2px 0;
      gap: 8px;
    }
    .big {
      font-size: 17px;
      font-weight: 600;
      margin-top: 4px;
    }
    .small {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }
    .total-card {
      margin-top: 10px;
      background: #ecfeff;
      border-color: #06b6d4;
    }
    .share-row {
      margin-top: 8px;
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      flex-wrap: wrap;
    }
    .saved-estimate-item {
      padding: 4px 0;
      border-top: 1px dashed #e5e7eb;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      cursor: pointer;
    }
    .saved-estimate-main {
      display: flex;
      flex-direction: column;
    }
    .saved-estimate-title {
      font-size: 12px;
      color: #111827;
    }
    .saved-estimate-meta {
      font-size: 11px;
      color: #6b7280;
    }
    .saved-estimate-total {
      font-size: 12px;
      font-weight: 600;
      color: #0f766e;
      white-space: nowrap;
    }
    .photo-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 6px;
    }
    .photo-preview {
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
      border: 1px dashed #d1d5db;
      object-fit: cover;
      display: none;
    }
    /* Admin modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal {
      background: #ffffff;
      border-radius: 14px;
      max-width: 640px;
      width: 94%;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(15,23,42,0.4);
      border: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
    }
    .modal-header {
      padding: 10px 12px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #0f172a;
      color: #f9fafb;
    }
    .modal-header h3 {
      margin: 0;
      font-size: 14px;
    }
    .modal-body {
      padding: 10px 12px;
      overflow: auto;
      background: #f9fafb;
      font-size: 12px;
    }
    .modal-footer {
      padding: 8px 12px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      background: #ffffff;
    }
    .close-x {
      border: none;
      background: transparent;
      color: #e5e7eb;
      font-size: 16px;
      cursor: pointer;
    }
    .admin-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
      margin-bottom: 8px;
    }
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      margin-top: 6px;
      background: #ffffff;
    }
    .admin-table th,
    .admin-table td {
      border: 1px solid #e5e7eb;
      padding: 3px;
    }
    .admin-table th {
      background: #e5e7eb;
      font-weight: 600;
    }
    .admin-table input,
    .admin-table select {
      width: 100%;
      font-size: 11px;
      padding: 3px 4px;
      border-radius: 6px;
    }
    @media print {
      .btn-main,
      .btn-ghost,
      #saveEstimateBtn,
      #shareWhatsAppBtn,
      #shareEmailBtn,
      #jobPhotoInput,
      #adminButton,
      #newEstimateBtn {
        display: none !important;
      }
      body {
        background: #ffffff;
      }
      .app {
        box-shadow: none;
        margin: 0;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="header-logo">
        <img src="proshields-logo.png" alt="M&A ProShields Logo">
      </div>
      <p class="header-title">M&amp;A ProShields Estimator</p>
      <p class="header-sub">Internal Estimator Tool</p>
    </div>

    <div class="client-card">
      <div class="client-grid">
        <div class="full">
          <label for="clientName">Client name</label>
          <input id="clientName" type="text" placeholder="Client full name">
        </div>
        <div>
          <label for="clientPhone">Phone</label>
          <input id="clientPhone" type="tel" placeholder="(xxx) xxx-xxxx">
        </div>
        <div>
          <label for="estimateDate">Date</label>
          <input id="estimateDate" type="date">
        </div>
        <div class="full">
          <label for="clientAddress">Address / Project location</label>
          <input id="clientAddress" type="text" placeholder="Street, city, ZIP">
        </div>
        <div class="full">
          <label for="estimatorName">Estimator</label>
          <input id="estimatorName" type="text" placeholder="Your name">
        </div>
      </div>
    </div>

    <div class="top-actions">
      <div style="display:flex; gap:6px; flex-wrap:wrap;">
        <button id="adminButton" class="btn-ghost">Admin</button>
        <button id="newEstimateBtn" class="btn-ghost">New estimate</button>
      </div>
      <div style="display:flex; gap:6px; flex-wrap:wrap;">
        <button class="btn-main" onclick="window.print()">Print / Save as PDF</button>
      </div>
    </div>

    <div class="top-actions">
      <div style="flex:1;">
        <label>Project type (main category)</label>
      </div>
    </div>

    <div class="project-buttons">
      <button class="pbtn active" data-label="Screen Room">Screen Room</button>
      <button class="pbtn" data-label="Pool Enclosure / Screen Cage">Pool Enclosure / Screen Cage</button>
      <button class="pbtn" data-label="Pergola">Pergola</button>
      <button class="pbtn" data-label="Lanai">Lanai</button>
      <button class="pbtn" data-label="Carport">Carport</button>
      <button class="pbtn" data-label="Sunroom">Sunroom</button>
      <button class="pbtn" data-label="Patio Roof">Patio Roof</button>
      <button class="pbtn" data-label="Motorized Screen Cage Pergola">Motorized Screen Cage Pergola</button>
      <button class="pbtn" data-label="Custom">Custom</button>
      <button class="pbtn" data-label="Extra Service">Extra Service</button>
    </div>
    <div class="current-project" id="currentProjectText">
      Current project: Screen Room
    </div>

    <table class="services-table" id="servicesTable">
      <thead>
        <tr>
          <th class="service-col">Service</th>
          <th style="width:8%;">Width</th>
          <th style="width:8%;">Length</th>
          <th style="width:8%;">Height</th>
          <th style="width:8%;">Qty</th>
          <th style="width:16%;">Unit type</th>
          <th class="price-cell">Line total</th>
          <th style="width:4%;"></th>
        </tr>
      </thead>
      <tbody id="lineItemsBody">
      </tbody>
    </table>
    <div class="add-row">
      <button class="btn secondary" id="addRowBtn">+ Add service</button>
    </div>

    <div class="card">
      <h2>Detalles del trabajo / Job details</h2>

      <label for="roofType">Tipo de techo / Roof type:</label>
      <select id="roofType">
        <option value="">Seleccione... / Select...</option>
        <option>Techo insulado 3"</option>
        <option>Techo insulado 4"</option>
        <option>Pan roof</option>
        <option>Screen roof</option>
        <option>Pergola / Louvered</option>
        <option>Otro (describir abajo)</option>
      </select>

      <label for="connectionType" style="margin-top:6px;">Conexión a la casa / Connection type:</label>
      <select id="connectionType">
        <option value="">Seleccione... / Select...</option>
        <option>A la fascia</option>
        <option>A la pared (wall connection)</option>
        <option>Sobre el overhang / roof</option>
        <option>Con super gutter nuevo</option>
        <option>Usando gutter existente</option>
        <option>Estructura independiente (freestanding)</option>
      </select>

      <label for="concreteDrain" style="margin-top:6px;">Concreto y drenaje / Concrete and drainage:</label>
      <select id="concreteDrain">
        <option value="">Seleccione... / Select...</option>
        <option>Usa losa existente</option>
        <option>Incluye nueva losa de concreto</option>
        <option>Solo footers 12&quot; x 12&quot;</option>
        <option>Sobre pavers existentes</option>
        <option>Otro (describir abajo)</option>
      </select>

      <label for="panelsFrames" style="margin-top:6px;">Paneles y marcos / Panels and frames:</label>
      <textarea id="panelsFrames" placeholder="Ej: Screen 18/14, kickplate 16&quot;, decorative wall panels, etc."></textarea>

      <label for="optionalAccessories" style="margin-top:6px;">Accesorios opcionales / Optional accessories:</label>
      <textarea id="optionalAccessories" placeholder="Ej: LED lights, ceiling fans, outlets, extra doors, etc."></textarea>

      <label for="generalNotes" style="margin-top:6px;">Notas generales del trabajo / General notes:</label>
      <textarea id="generalNotes" placeholder="Cualquier detalle adicional del trabajo que quieras dejar escrito."></textarea>

      <div class="photo-row">
        <label for="jobPhotoInput" style="margin-top:6px;">Foto del sitio / Job photo:</label>
        <input id="jobPhotoInput" type="file" accept="image/*" capture="environment">
        <img id="jobPhotoPreview" class="photo-preview" alt="Job photo preview">
        <div class="small">
          La foto se guarda solo en este dispositivo para este estimado.  
          The photo is kept only on this device (not uploaded to a server).
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Totals & Overall Discount</h2>
      <div class="line">
        <span>Subtotal (before discount)</span>
        <span id="subtotalText">$0.00</span>
      </div>

      <div class="line">
        <div style="flex:1;">
          <label for="globalDiscountInput">Extra discount % on total</label>
          <input type="number" id="globalDiscountInput" min="0" max="100" step="1" value="0">
        </div>
        <div style="flex:1;">
          <label>Discount amount</label>
          <div style="text-align:right;font-size:13px;" id="globalDiscountAmountText">$0.00</div>
        </div>
      </div>

      <div class="line big">
        <span>Total after discount</span>
        <span id="grandTotalText">$0.00</span>
      </div>
      <div class="small">
        Use the discount % only at the end if you want to close the deal.
      </div>

      <div class="share-row">
        <button class="btn small secondary" id="saveEstimateBtn">Save estimate (history)</button>
        <button class="btn small secondary" id="shareWhatsAppBtn">WhatsApp</button>
        <button class="btn small secondary" id="shareEmailBtn">Email</button>
      </div>
    </div>

    <div class="card total-card">
      <div class="line big">
        <span>Total to say to client</span>
        <span id="clientTotalText">$0.00</span>
      </div>
      <div class="small">
        You can round mentally before saying it (ex: 8,945 → 8,900 or 8,950).
      </div>
    </div>

    <div class="card" id="savedEstimatesCard">
      <h2>Saved estimates (this device)</h2>
      <div class="small">
        Tap a row to see quick summary. These are stored only on this iPad/phone (local storage).
      </div>
      <div id="savedEstimatesList" style="margin-top:6px;"></div>
    </div>
  </div>

  <!-- Admin modal -->
  <div class="modal-backdrop" id="adminModalBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="adminModalTitle">
      <div class="modal-header">
        <h3 id="adminModalTitle">Admin – Services & Prices</h3>
        <button class="close-x" id="adminCloseBtn">&times;</button>
      </div>
      <div class="modal-body">
        <div id="adminLoginSection">
          <label for="adminPinInput">PIN</label>
          <input type="password" id="adminPinInput" placeholder="4-digit PIN">
          <div style="margin-top:8px; display:flex; justify-content:flex-end; gap:6px;">
            <button class="btn small secondary" id="adminCancelLoginBtn">Cancel</button>
            <button class="btn small" id="adminLoginBtn">Enter</button>
          </div>
        </div>

        <div id="adminPanelSection" style="display:none;">
          <div class="admin-grid">
            <div>
              <label for="adminProjectSelect">Project type to edit</label>
              <select id="adminProjectSelect"></select>
            </div>
          </div>

          <table class="admin-table" id="adminServicesTable">
            <thead>
              <tr>
                <th style="width:40%;">Service name</th>
                <th style="width:22%;">Unit type</th>
                <th style="width:18%;">Unit price ($)</th>
                <th style="width:10%;">Use?</th>
              </tr>
            </thead>
            <tbody id="adminServicesBody">
            </tbody>
          </table>
          <p class="small" style="margin-top:6px;">
            These services are the defaults that appear when you change project type or start a new estimate.  
            Unit price is internal (clients will not see it).
          </p>
        </div>
      </div>
      <div class="modal-footer" id="adminFooter">
        <button class="btn small" id="adminSaveBtn">Save</button>
      </div>
    </div>
  </div>

  <script>
    // ======= GLOBAL ELEMENTS =======
    const lineItemsBody = document.getElementById('lineItemsBody');
    const subtotalText = document.getElementById('subtotalText');
    const globalDiscountInput = document.getElementById('globalDiscountInput');
    const globalDiscountAmountText = document.getElementById('globalDiscountAmountText');
    const grandTotalText = document.getElementById('grandTotalText');
    const clientTotalText = document.getElementById('clientTotalText');
    const savedEstimatesList = document.getElementById('savedEstimatesList');
    const currentProjectText = document.getElementById('currentProjectText');
    const jobPhotoInput = document.getElementById('jobPhotoInput');
    const jobPhotoPreview = document.getElementById('jobPhotoPreview');

    const adminModalBackdrop = document.getElementById('adminModalBackdrop');
    const adminButton = document.getElementById('adminButton');
    const adminCloseBtn = document.getElementById('adminCloseBtn');
    const adminCancelLoginBtn = document.getElementById('adminCancelLoginBtn');
    const adminLoginBtn = document.getElementById('adminLoginBtn');
    const adminPinInput = document.getElementById('adminPinInput');
    const adminLoginSection = document.getElementById('adminLoginSection');
    const adminPanelSection = document.getElementById('adminPanelSection');
    const adminProjectSelect = document.getElementById('adminProjectSelect');
    const adminServicesBody = document.getElementById('adminServicesBody');
    const adminSaveBtn = document.getElementById('adminSaveBtn');
    const adminFooter = document.getElementById('adminFooter');

    const newEstimateBtn = document.getElementById('newEstimateBtn');
    const saveEstimateBtn = document.getElementById('saveEstimateBtn');
    const shareWhatsAppBtn = document.getElementById('shareWhatsAppBtn');
    const shareEmailBtn = document.getElementById('shareEmailBtn');

    const CURRENT_ESTIMATE_KEY = 'proshields_current_estimate_v1';
    const SAVED_ESTIMATES_KEY = 'proshields_estimates_history_v1';
    const ADMIN_CONFIG_KEY = 'proshields_admin_config_v3';
    const ADMIN_PIN = '2580'; // default PIN

    const PROJECT_TYPES = [
      'Screen Room',
      'Pool Enclosure / Screen Cage',
      'Pergola',
      'Lanai',
      'Carport',
      'Sunroom',
      'Patio Roof',
      'Motorized Screen Cage Pergola',
      'Custom',
      'Extra Service'
    ];

    const ADMIN_PROJECT_KEYS = PROJECT_TYPES.slice();

    function formatMoney(value) {
      if (!isFinite(value)) value = 0;
      return '$' + value.toFixed(2);
    }

    // ======= ADMIN CONFIG (DEFAULT SERVICES) =======
    function makeRow(name = '', unitType = 'each', price = 0, use = false) {
      return { name, unitType, price, use };
    }

    function getDefaultAdminConfig() {
      const config = {};
      PROJECT_TYPES.forEach(pt => {
        const rows = [];
        if (pt === 'Screen Room') {
          rows.push(makeRow('Screen roof', 'sqft_wl', 7, true));
          rows.push(makeRow('Insulated roof', 'sqft_wl', 18, true));
          rows.push(makeRow('Screen walls', 'sqft_lh', 7, true));
          rows.push(makeRow('Door kit', 'each', 350, true));
          rows.push(makeRow('Kickplate', 'linear', 12, false));
        } else if (pt === 'Pool Enclosure / Screen Cage') {
          rows.push(makeRow('Re-screen cage', 'sqft_qty', 3, true));
          rows.push(makeRow('Super gutter', 'linear', 28, true));
          rows.push(makeRow('Door replacement', 'each', 450, true));
        } else if (pt === 'Pergola') {
          rows.push(makeRow('Pergola roof area', 'sqft_wl', 25, true));
          rows.push(makeRow('Posts', 'each', 180, true));
        } else if (pt === 'Lanai') {
          rows.push(makeRow('Lanai screen walls', 'sqft_lh', 7, true));
          rows.push(makeRow('Screen roof lanai', 'sqft_wl', 7, false));
        }
        const targetLen = (pt === 'Extra Service') ? 30 : 20;
        while (rows.length < targetLen) rows.push(makeRow());
        config[pt] = rows;
      });
      return config;
    }

    function loadAdminConfig() {
      let cfg;
      try {
        const stored = localStorage.getItem(ADMIN_CONFIG_KEY);
        if (stored) {
          cfg = JSON.parse(stored);
        }
      } catch (e) {
        cfg = null;
      }
      if (!cfg) cfg = getDefaultAdminConfig();

      // Ensure keys and lengths
      ADMIN_PROJECT_KEYS.forEach(pt => {
        if (!cfg[pt]) cfg[pt] = [];
        const targetLen = (pt === 'Extra Service') ? 30 : 20;
        while (cfg[pt].length < targetLen) cfg[pt].push(makeRow());
      });
      return cfg;
    }

    function saveAdminConfig(config) {
      localStorage.setItem(ADMIN_CONFIG_KEY, JSON.stringify(config));
    }

    let adminConfig = loadAdminConfig();

    // ======= ROW MANAGEMENT =======
    function addRow(defaultService = '', defaultUnitType = 'each', defaultPrice = 0) {
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td>
          <input type="text" class="svc-name" placeholder="Service description" value="${defaultService}">
          <input type="hidden" class="unit-price" value="${defaultPrice}">
        </td>
        <td><input type="number" class="num width" min="0" step="0.01"></td>
        <td><input type="number" class="num length" min="0" step="0.01"></td>
        <td><input type="number" class="num height" min="0" step="0.01"></td>
        <td><input type="number" class="num qty" min="0" step="0.01"></td>
        <td>
          <select class="unit-type">
            <option value="each">each</option>
            <option value="sqft_wl">sq ft (W x L)</option>
            <option value="sqft_lh">sq ft (L x H)</option>
            <option value="sqft_qty">sq ft (Qty)</option>
            <option value="linear">linear ft</option>
          </select>
        </td>
        <td class="price-cell line-total">$0.00</td>
        <td><button class="remove-btn" title="Remove line">&times;</button></td>
      `;

      lineItemsBody.appendChild(tr);

      const svcInput = tr.querySelector('.svc-name');
      const unitPriceHidden = tr.querySelector('.unit-price');
      const unitTypeSelect = tr.querySelector('.unit-type');

      unitTypeSelect.value = defaultUnitType || 'each';

      // double tap to edit internal price
      svcInput.addEventListener('dblclick', () => {
        const current = parseFloat(unitPriceHidden.value) || 0;
        const entered = prompt('Internal unit price for this line (not shown to client):', current);
        if (entered === null) return;
        const v = parseFloat(entered);
        if (!isNaN(v) && v >= 0) {
          unitPriceHidden.value = v.toString();
          calculateTotals();
          saveCurrentEstimate();
        }
      });

      tr.querySelectorAll('input.num, select.unit-type, .svc-name').forEach(el => {
        el.addEventListener('input', () => {
          calculateTotals();
          saveCurrentEstimate();
        });
      });

      tr.querySelector('.remove-btn').addEventListener('click', () => {
        tr.remove();
        calculateTotals();
        saveCurrentEstimate();
      });

      return tr;
    }

    function clearAllRows() {
      while (lineItemsBody.firstChild) {
        lineItemsBody.removeChild(lineItemsBody.firstChild);
      }
    }

    function loadProjectDefaults(projectType) {
      const rows = adminConfig[projectType] || [];
      clearAllRows();

      let rowsToUse;
      if (projectType === 'Extra Service') {
        // show all extra service lines
        rowsToUse = rows;
      } else {
        rowsToUse = rows.filter(r => r.use);
      }

      if (!rowsToUse.length) {
        for (let i = 0; i < 10; i++) addRow();
      } else {
        rowsToUse.forEach(r => addRow(r.name, r.unitType, r.price));
      }

      calculateTotals();
      saveCurrentEstimate();
    }

    // ======= TOTALS =======
    function calculateTotals() {
      let subtotal = 0;

      Array.from(lineItemsBody.querySelectorAll('tr')).forEach(tr => {
        const w = parseFloat(tr.querySelector('.width').value) || 0;
        const l = parseFloat(tr.querySelector('.length').value) || 0;
        const h = parseFloat(tr.querySelector('.height').value) || 0;
        const qtyField = parseFloat(tr.querySelector('.qty').value) || 0;
        const unitPrice = parseFloat(tr.querySelector('.unit-price').value) || 0;
        const unitType = tr.querySelector('.unit-type').value;

        let qty;
        if (unitType === 'sqft_wl') {
          qty = w * l;              // Width x Length
        } else if (unitType === 'sqft_lh') {
          qty = l * h;              // Length x Height
        } else if (unitType === 'sqft_qty') {
          qty = qtyField;           // Direct sq ft number
        } else {
          qty = qtyField;           // each / linear ft
        }

        const lineTotal = qty * unitPrice;
        subtotal += lineTotal;
        tr.querySelector('.line-total').textContent = formatMoney(lineTotal);
      });

      subtotalText.textContent = formatMoney(subtotal);

      const discPercent = parseFloat(globalDiscountInput.value) || 0;
      const discountAmount = subtotal * (discPercent / 100);
      const grandTotal = subtotal - discountAmount;

      globalDiscountAmountText.textContent = formatMoney(discountAmount);
      grandTotalText.textContent = formatMoney(grandTotal);
      clientTotalText.textContent = formatMoney(grandTotal);
    }

    // ======= CURRENT PROJECT =======
    function getCurrentProjectLabel() {
      const active = document.querySelector('.pbtn.active');
      return active ? active.getAttribute('data-label') : 'Screen Room';
    }

    // ======= CURRENT ESTIMATE SAVE/LOAD (AUTOSAVE) =======
    function collectCurrentEstimateData() {
      const lines = [];
      Array.from(lineItemsBody.querySelectorAll('tr')).forEach(tr => {
        const svc = tr.querySelector('.svc-name').value || '';
        const w = parseFloat(tr.querySelector('.width').value) || 0;
        const l = parseFloat(tr.querySelector('.length').value) || 0;
        const h = parseFloat(tr.querySelector('.height').value) || 0;
        const qtyField = parseFloat(tr.querySelector('.qty').value) || 0;
        const unitPrice = parseFloat(tr.querySelector('.unit-price').value) || 0;
        const unitType = tr.querySelector('.unit-type').value;
        const lineTotalText = tr.querySelector('.line-total').textContent || '$0.00';
        lines.push({
          service: svc,
          width: w,
          length: l,
          height: h,
          qty: qtyField,
          unitType,
          unitPrice,
          lineTotalText
        });
      });

      const subtotal = parseFloat(subtotalText.textContent.replace(/[^0-9.\-]/g, '')) || 0;
      const discountPercent = parseFloat(globalDiscountInput.value) || 0;
      const total = parseFloat(grandTotalText.textContent.replace(/[^0-9.\-]/g, '')) || 0;

      return {
        clientName: document.getElementById('clientName').value || '',
        phone: document.getElementById('clientPhone').value || '',
        date: document.getElementById('estimateDate').value || '',
        address: document.getElementById('clientAddress').value || '',
        estimator: document.getElementById('estimatorName').value || '',
        projectType: getCurrentProjectLabel(),
        subtotal,
        discountPercent,
        total,
        lines,
        roofType: document.getElementById('roofType').value || '',
        connectionType: document.getElementById('connectionType').value || '',
        concreteDrain: document.getElementById('concreteDrain').value || '',
        panelsFrames: document.getElementById('panelsFrames').value || '',
        optionalAccessories: document.getElementById('optionalAccessories').value || '',
        generalNotes: document.getElementById('generalNotes').value || '',
        photoDataUrl: jobPhotoPreview && jobPhotoPreview.src && jobPhotoPreview.style.display === 'block' ? jobPhotoPreview.src : ''
      };
    }

    function saveCurrentEstimate() {
      const data = collectCurrentEstimateData();
      try {
        localStorage.setItem(CURRENT_ESTIMATE_KEY, JSON.stringify(data));
      } catch (e) {
        console.warn('Could not save current estimate', e);
      }
    }

    function loadCurrentEstimate() {
      try {
        const raw = localStorage.getItem(CURRENT_ESTIMATE_KEY);
        if (!raw) {
          loadProjectDefaults('Screen Room');
          return;
        }
        const est = JSON.parse(raw);
        document.getElementById('clientName').value = est.clientName || '';
        document.getElementById('clientPhone').value = est.phone || '';
        document.getElementById('estimateDate').value = est.date || '';
        document.getElementById('clientAddress').value = est.address || '';
        document.getElementById('estimatorName').value = est.estimator || '';

        const targetProject = est.projectType || 'Screen Room';
        document.querySelectorAll('.pbtn').forEach(btn => {
          const label = btn.getAttribute('data-label');
          if (label === targetProject) btn.classList.add('active');
          else btn.classList.remove('active');
        });
        currentProjectText.textContent = 'Current project: ' + targetProject;

        clearAllRows();
        (est.lines || []).forEach(line => {
          const tr = addRow(line.service || '', line.unitType || 'each', line.unitPrice || 0);
          tr.querySelector('.width').value = line.width || 0;
          tr.querySelector('.length').value = line.length || 0;
          tr.querySelector('.height').value = line.height || 0;
          tr.querySelector('.qty').value = line.qty || 0;
        });
        if (!lineItemsBody.children.length) {
          loadProjectDefaults(targetProject);
        }

        globalDiscountInput.value = est.discountPercent || 0;

        document.getElementById('roofType').value = est.roofType || '';
        document.getElementById('connectionType').value = est.connectionType || '';
        document.getElementById('concreteDrain').value = est.concreteDrain || '';
        document.getElementById('panelsFrames').value = est.panelsFrames || '';
        document.getElementById('optionalAccessories').value = est.optionalAccessories || '';
        document.getElementById('generalNotes').value = est.generalNotes || '';

        if (est.photoDataUrl) {
          jobPhotoPreview.src = est.photoDataUrl;
          jobPhotoPreview.style.display = 'block';
        } else {
          jobPhotoPreview.src = '';
          jobPhotoPreview.style.display = 'none';
        }

        calculateTotals();
      } catch (e) {
        console.warn('Could not load current estimate, using defaults.', e);
        loadProjectDefaults('Screen Room');
      }
    }

    function clearCurrentEstimate() {
      localStorage.removeItem(CURRENT_ESTIMATE_KEY);
    }

    // ======= HISTORY SAVE =======
    function loadSavedEstimatesList() {
      savedEstimatesList.innerHTML = '';
      let list = [];
      try {
        list = JSON.parse(localStorage.getItem(SAVED_ESTIMATES_KEY) || '[]');
      } catch (e) {
        list = [];
      }
      if (!list.length) {
        const empty = document.createElement('div');
        empty.className = 'small';
        empty.textContent = 'No saved estimates yet.';
        savedEstimatesList.appendChild(empty);
        return;
      }
      list.slice().reverse().forEach(item => {
        const row = document.createElement('div');
        row.className = 'saved-estimate-item';
        const main = document.createElement('div');
        main.className = 'saved-estimate-main';
        const title = document.createElement('div');
        title.className = 'saved-estimate-title';
        title.textContent = (item.clientName || 'No name') + ' – ' + (item.projectType || 'Project');
        const meta = document.createElement('div');
        meta.className = 'saved-estimate-meta';
        meta.textContent = (item.date || 'No date') + ' • ' + (item.address || 'No address') + ' • ' + (item.phone || 'No phone');
        main.appendChild(title);
        main.appendChild(meta);
        const totalDiv = document.createElement('div');
        totalDiv.className = 'saved-estimate-total';
        totalDiv.textContent = formatMoney(item.total || 0);
        row.appendChild(main);
        row.appendChild(totalDiv);
        row.addEventListener('click', () => {
          alert(
            'Client: ' + (item.clientName || 'N/A') + '\n' +
            'Project: ' + (item.projectType || 'N/A') + '\n' +
            'Date: ' + (item.date || 'N/A') + '\n' +
            'Address: ' + (item.address || 'N/A') + '\n' +
            'Phone: ' + (item.phone || 'N/A') + '\n\n' +
            'Subtotal: ' + formatMoney(item.subtotal || 0) + '\n' +
            'Discount %: ' + (item.discountPercent || 0) + '%\n' +
            'Total: ' + formatMoney(item.total || 0)
          );
        });
        savedEstimatesList.appendChild(row);
      });
    }

    function saveEstimateToHistory() {
      const data = collectCurrentEstimateData();
      let list = [];
      try {
        list = JSON.parse(localStorage.getItem(SAVED_ESTIMATES_KEY) || '[]');
      } catch (e) {
        list = [];
      }
      list.push(data);
      localStorage.setItem(SAVED_ESTIMATES_KEY, JSON.stringify(list));
      loadSavedEstimatesList();
      alert('Estimate saved to history on this device.');
    }

    // ======= SHARE TEXT =======
    function buildShareText() {
      const est = collectCurrentEstimateData();
      let text = '';
      text += 'ProShields Estimate\n';
      text += 'Client: ' + (est.clientName || 'N/A') + '\n';
      text += 'Project: ' + (est.projectType || 'N/A') + '\n';
      if (est.date) text += 'Date: ' + est.date + '\n';
      if (est.address) text += 'Address: ' + est.address + '\n';
      if (est.phone) text += 'Phone: ' + est.phone + '\n';
      if (est.estimator) text += 'Estimator: ' + est.estimator + '\n';
      text += '\nJob details:\n';
      if (est.roofType) text += '- Roof type: ' + est.roofType + '\n';
      if (est.connectionType) text += '- Connection: ' + est.connectionType + '\n';
      if (est.concreteDrain) text += '- Concrete/drainage: ' + est.concreteDrain + '\n';
      if (est.panelsFrames) text += '- Panels/frames: ' + est.panelsFrames + '\n';
      if (est.optionalAccessories) text += '- Accessories: ' + est.optionalAccessories + '\n';
      if (est.generalNotes) text += '- Notes: ' + est.generalNotes + '\n';
      if (est.photoDataUrl) text += '- Job photo: yes (check on device)\n';

      text += '\nDetails:\n';
      est.lines.forEach((line, idx) => {
        if (!line.service && !line.qty && !line.unitPrice) return;
        text += (idx + 1) + '. ' + (line.service || 'Service') + ' – ' +
                (line.qty || 0) + ' ' + (line.unitType || '') +
                ' @ ' + formatMoney(line.unitPrice || 0) +
                ' = ' + line.lineTotalText + '\n';
      });
      text += '\nSubtotal: ' + formatMoney(est.subtotal || 0) + '\n';
      text += 'Discount: ' + (est.discountPercent || 0) + '%\n';
      text += 'Total: ' + formatMoney(est.total || 0) + '\n';
      text += '\nProShields Patio Covers & Aluminum Systems';
      return text;
    }

    // ======= ADMIN MODAL LOGIC =======
    function openAdminModal() {
      adminLoginSection.style.display = 'block';
      adminPanelSection.style.display = 'none';
      adminFooter.style.display = 'none';
      adminPinInput.value = '';
      adminModalBackdrop.style.display = 'flex';
      adminPinInput.focus();
    }

    function closeAdminModal() {
      adminModalBackdrop.style.display = 'none';
    }

    function fillAdminProjectSelect() {
      adminProjectSelect.innerHTML = '';
      ADMIN_PROJECT_KEYS.forEach(pt => {
        const opt = document.createElement('option');
        opt.value = pt;
        opt.textContent = pt;
        adminProjectSelect.appendChild(opt);
      });
    }

    function loadAdminTableForProject(pt) {
      const rows = adminConfig[pt] || [];
      adminServicesBody.innerHTML = '';
      rows.forEach((row, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="text" data-index="${index}" data-field="name" value="${row.name || ''}"></td>
          <td>
            <select data-index="${index}" data-field="unitType">
              <option value="each">each</option>
              <option value="sqft_wl">sq ft (W x L)</option>
              <option value="sqft_lh">sq ft (L x H)</option>
              <option value="sqft_qty">sq ft (Qty)</option>
              <option value="linear">linear ft</option>
            </select>
          </td>
          <td><input type="number" min="0" step="0.01" data-index="${index}" data-field="price" value="${row.price || 0}"></td>
          <td style="text-align:center;">
            <input type="checkbox" data-index="${index}" data-field="use" ${row.use ? 'checked' : ''}>
          </td>
        `;
        const select = tr.querySelector('select[data-field="unitType"]');
        select.value = row.unitType || 'each';
        adminServicesBody.appendChild(tr);
      });
    }

    function readAdminTableIntoConfig(pt) {
      const rows = adminConfig[pt] || [];
      adminServicesBody.querySelectorAll('input, select').forEach(el => {
        const idx = parseInt(el.getAttribute('data-index'), 10);
        const field = el.getAttribute('data-field');
        if (isNaN(idx) || !field) return;
        if (!rows[idx]) rows[idx] = makeRow();
        if (field === 'use') {
          rows[idx].use = el.checked;
        } else if (field === 'price') {
          rows[idx].price = parseFloat(el.value) || 0;
        } else if (field === 'unitType') {
          rows[idx].unitType = el.value;
        } else if (field === 'name') {
          rows[idx].name = el.value || '';
        }
      });
      adminConfig[pt] = rows;
    }

    // ======= EVENT LISTENERS =======
    document.addEventListener('DOMContentLoaded', () => {
      // Project buttons
      document.querySelectorAll('.pbtn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.pbtn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          const label = btn.getAttribute('data-label') || 'Project';
          currentProjectText.textContent = 'Current project: ' + label;
          loadProjectDefaults(label);
          saveCurrentEstimate();
        });
      });

      // Add row button
      document.getElementById('addRowBtn').addEventListener('click', () => {
        addRow();
        saveCurrentEstimate();
      });

      // Discount
      globalDiscountInput.addEventListener('input', () => {
        calculateTotals();
        saveCurrentEstimate();
      });

      // Autosave fields
      ['clientName','clientPhone','estimateDate','clientAddress','estimatorName',
       'roofType','connectionType','concreteDrain','panelsFrames',
       'optionalAccessories','generalNotes'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', saveCurrentEstimate);
      });

      // Photo input
      jobPhotoInput.addEventListener('change', () => {
        const file = jobPhotoInput.files && jobPhotoInput.files[0];
        if (!file) {
          jobPhotoPreview.style.display = 'none';
          jobPhotoPreview.src = '';
          saveCurrentEstimate();
          return;
        }
        const reader = new FileReader();
        reader.onload = e => {
          jobPhotoPreview.src = e.target.result;
          jobPhotoPreview.style.display = 'block';
          saveCurrentEstimate();
        };
        reader.readAsDataURL(file);
      });

      // Admin modal buttons
      adminButton.addEventListener('click', openAdminModal);
      adminCloseBtn.addEventListener('click', closeAdminModal);
      adminCancelLoginBtn.addEventListener('click', closeAdminModal);

      adminLoginBtn.addEventListener('click', () => {
        const pin = adminPinInput.value.trim();
        if (pin === ADMIN_PIN) {
          adminLoginSection.style.display = 'none';
          adminPanelSection.style.display = 'block';
          adminFooter.style.display = 'flex';
          fillAdminProjectSelect();
          const currentProject = getCurrentProjectLabel();
          adminProjectSelect.value = currentProject;
          loadAdminTableForProject(currentProject);
        } else {
          alert('Incorrect PIN');
        }
      });

      adminProjectSelect.addEventListener('change', () => {
        const pt = adminProjectSelect.value;
        loadAdminTableForProject(pt);
      });

      adminSaveBtn.addEventListener('click', () => {
        const pt = adminProjectSelect.value;
        readAdminTableIntoConfig(pt);
        saveAdminConfig(adminConfig);
        alert('Admin changes saved. New estimates / project changes will use these defaults.');
      });

      // New estimate button
      newEstimateBtn.addEventListener('click', () => {
        if (!confirm('Start a new estimate? This clears the current form (history will stay).')) return;
        clearCurrentEstimate();
        document.getElementById('clientName').value = '';
        document.getElementById('clientPhone').value = '';
        document.getElementById('estimateDate').value = '';
        document.getElementById('clientAddress').value = '';
        document.getElementById('estimatorName').value = '';
        globalDiscountInput.value = 0;
        document.getElementById('roofType').value = '';
        document.getElementById('connectionType').value = '';
        document.getElementById('concreteDrain').value = '';
        document.getElementById('panelsFrames').value = '';
        document.getElementById('optionalAccessories').value = '';
        document.getElementById('generalNotes').value = '';
        jobPhotoPreview.src = '';
        jobPhotoPreview.style.display = 'none';
        jobPhotoInput.value = '';

        document.querySelectorAll('.pbtn').forEach(btn => {
          const label = btn.getAttribute('data-label');
          if (label === 'Screen Room') btn.classList.add('active');
          else btn.classList.remove('active');
        });
        currentProjectText.textContent = 'Current project: Screen Room';
        loadProjectDefaults('Screen Room');
        calculateTotals();
        saveCurrentEstimate();
      });

      // Save to history
      saveEstimateBtn.addEventListener('click', saveEstimateToHistory);

      // Share buttons
      shareWhatsAppBtn.addEventListener('click', () => {
        const text = encodeURIComponent(buildShareText());
        const url = 'https://wa.me/?text=' + text;
        window.open(url, '_blank');
      });

      shareEmailBtn.addEventListener('click', () => {
        const subject = encodeURIComponent('Estimate – ProShields Patio Covers');
        const body = encodeURIComponent(buildShareText());
        const url = 'mailto:?subject=' + subject + '&body=' + body;
        window.location.href = url;
      });

      // Initial load
      loadCurrentEstimate();
      loadSavedEstimatesList();
    });
  </script>
</body>
</html>
